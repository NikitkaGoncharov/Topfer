{% extends 'finance/base.html' %}

{% block title %}Аналитика - Topfer{% endblock %}

{% block page_title %}Аналитика{% endblock %}

{% block extra_css %}
<style>
    /* Адаптация для мобильных устройств */
    @media (max-width: 767.98px) {
        /* Компактные заголовки */
        .widget-title {
            font-size: 1rem !important;
        }

        /* Компактные таблицы */
        .table {
            font-size: 0.875rem;
        }

        .table th,
        .table td {
            padding: 0.5rem !important;
        }

        /* Скрываем колонку "Транзакций" на мобильных для экономии места */
        .table .transactions-col {
            display: none;
        }

        /* Адаптивные карточки категорий на мобильных */
        .category-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        .category-card:last-child {
            border-bottom: none;
        }

        .category-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-amount {
            font-size: 1rem;
            font-weight: 700;
        }

        .category-count {
            font-size: 0.75rem;
            color: #6c757d;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-12 col-lg-6 mb-4 mb-lg-0">
        <div class="widget">
            <h5 class="widget-title text-danger">
                <i class="bi bi-pie-chart-fill"></i> Распределение расходов по категориям
            </h5>
            {% if expense_chart_data.labels %}
            <div style="position: relative; height: 400px;">
                <canvas id="expenseChart"></canvas>
            </div>
            {% else %}
            <p class="text-muted text-center py-5">Нет данных о расходах для отображения</p>
            {% endif %}
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="widget">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h5 class="widget-title text-primary mb-0">
                    <i class="bi bi-bar-chart-fill"></i> Сравнение доходов и расходов
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" data-comparison-period="30">30 дней</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-comparison-period="90">90 дней</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-comparison-period="365">Год</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-comparison-period="all">Все время</button>
                </div>
            </div>
            {% if user.is_authenticated %}
            <div style="position: relative; height: 400px;">
                <canvas id="comparisonChart"></canvas>
            </div>
            {% else %}
            <p class="text-muted text-center py-5">Войдите в систему для просмотра сравнения</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="widget">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h5 class="widget-title text-info mb-0">
                    <i class="bi bi-graph-up"></i> Динамика баланса
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-info active" data-period="30">30 дней</button>
                    <button type="button" class="btn btn-sm btn-outline-info" data-period="90">90 дней</button>
                    <button type="button" class="btn btn-sm btn-outline-info" data-period="365">Год</button>
                </div>
            </div>
            {% if user.is_authenticated %}
            <div style="position: relative; height: 300px;">
                <canvas id="balanceChart"></canvas>
            </div>
            {% else %}
            <p class="text-muted text-center py-5">Войдите в систему для просмотра графика баланса</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 col-md-6 mb-4 mb-md-0">
        <div class="widget">
            <h5 class="widget-title text-danger">
                <i class="bi bi-arrow-down-circle"></i> Расходы по категориям
            </h5>
            {% if expense_by_category %}
            <!-- Десктопная версия (таблица) -->
            <div class="d-none d-md-block table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Категория</th>
                            <th class="text-end">Сумма</th>
                            <th class="text-end">Транзакций</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in expense_by_category %}
                        <tr>
                            <td>
                                {% if category.icon %}{{ category.icon }}{% endif %}
                                {{ category.category_name }}
                            </td>
                            <td class="text-end">{{ category.total_amount|default:0|floatformat:2 }} ₽</td>
                            <td class="text-end">{{ category.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Мобильная версия (карточки) -->
            <div class="d-md-none">
                {% for category in expense_by_category %}
                <div class="category-card">
                    <div>
                        <div class="category-name">
                            {% if category.icon %}{{ category.icon }} {% endif %}{{ category.category_name }}
                        </div>
                        <div class="category-count">{{ category.count }} транзакций</div>
                    </div>
                    <div class="category-amount text-danger">
                        {{ category.total_amount|default:0|floatformat:2 }} ₽
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Нет данных</p>
            {% endif %}
        </div>
    </div>

    <div class="col-12 col-md-6">
        <div class="widget">
            <h5 class="widget-title text-success">
                <i class="bi bi-arrow-up-circle"></i> Доходы по категориям
            </h5>
            {% if income_by_category %}
            <!-- Десктопная версия (таблица) -->
            <div class="d-none d-md-block table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Категория</th>
                            <th class="text-end">Сумма</th>
                            <th class="text-end">Транзакций</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in income_by_category %}
                        <tr>
                            <td>
                                {% if category.icon %}{{ category.icon }}{% endif %}
                                {{ category.category_name }}
                            </td>
                            <td class="text-end">{{ category.total_amount|default:0|floatformat:2 }} ₽</td>
                            <td class="text-end">{{ category.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Мобильная версия (карточки) -->
            <div class="d-md-none">
                {% for category in income_by_category %}
                <div class="category-card">
                    <div>
                        <div class="category-name">
                            {% if category.icon %}{{ category.icon }} {% endif %}{{ category.category_name }}
                        </div>
                        <div class="category-count">{{ category.count }} транзакций</div>
                    </div>
                    <div class="category-amount text-success">
                        {{ category.total_amount|default:0|floatformat:2 }} ₽
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Нет данных</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Подключаем Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // Инициализация диаграммы расходов по категориям
    {% if expense_chart_data.labels %}
    const expenseCtx = document.getElementById('expenseChart');

    const expenseChart = new Chart(expenseCtx, {
        type: 'pie',
        data: {
            labels: {{ expense_chart_data_json.labels|safe }},
            datasets: [{
                label: 'Расходы',
                data: {{ expense_chart_data_json.data|safe }},
                backgroundColor: {{ expense_chart_data_json.colors|safe }},
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const dataset = data.datasets[0];
                                const total = dataset.data.reduce((a, b) => a + b, 0);

                                return data.labels.map((label, i) => {
                                    const value = dataset.data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    return {
                                        text: `${label}: ${value.toLocaleString('ru-RU')} ₽ (${percentage}%)`,
                                        fillStyle: dataset.backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString('ru-RU')} ₽ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Адаптация для мобильных устройств
    if (window.innerWidth < 768) {
        expenseChart.options.plugins.legend.position = 'bottom';
        expenseChart.update();
    }

    // Обновление позиции легенды при изменении размера окна
    window.addEventListener('resize', function() {
        if (window.innerWidth < 768) {
            expenseChart.options.plugins.legend.position = 'bottom';
        } else {
            expenseChart.options.plugins.legend.position = 'right';
        }
        expenseChart.update();
    });
    {% endif %}

    // Инициализация столбчатой диаграммы сравнения доходов и расходов
    {% if user.is_authenticated %}
    const comparisonCtx = document.getElementById('comparisonChart');

    let comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: {{ comparison_chart_data_json.labels|safe }},
            datasets: [
                {
                    label: 'Расходы',
                    data: {{ comparison_chart_data_json.expenses|safe }},
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Доходы',
                    data: {{ comparison_chart_data_json.incomes|safe }},
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ₽';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ${value.toLocaleString('ru-RU')} ₽`;
                        }
                    }
                }
            }
        }
    });

    // Обработка кликов по кнопкам фильтра периода сравнения
    const comparisonPeriodButtons = document.querySelectorAll('.btn-group button[data-comparison-period]');

    comparisonPeriodButtons.forEach(button => {
        button.addEventListener('click', function() {
            const period = this.getAttribute('data-comparison-period');

            // Убираем активный класс со всех кнопок
            comparisonPeriodButtons.forEach(btn => btn.classList.remove('active'));

            // Добавляем активный класс к текущей кнопке
            this.classList.add('active');

            // Загружаем новые данные через AJAX
            fetch(`/api/comparison-data/?days=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Обновляем данные графика
                        comparisonChart.data.labels = data.data.labels;
                        comparisonChart.data.datasets[0].data = data.data.expenses;
                        comparisonChart.data.datasets[1].data = data.data.incomes;
                        comparisonChart.update();
                    } else {
                        console.error('Ошибка загрузки данных:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка запроса:', error);
                });
        });
    });
    {% endif %}

    // Инициализация линейного графика динамики баланса
    {% if user.is_authenticated %}
    const balanceCtx = document.getElementById('balanceChart');

    let balanceChart = new Chart(balanceCtx, {
        type: 'line',
        data: {
            labels: {{ balance_chart_data_json.labels|safe }},
            datasets: [{
                label: 'Баланс',
                data: {{ balance_chart_data_json.data|safe }},
                backgroundColor: 'rgba(23, 162, 184, 0.2)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(23, 162, 184, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ₽';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y || 0;
                            return `Баланс: ${value.toLocaleString('ru-RU')} ₽`;
                        }
                    }
                }
            }
        }
    });

    // Обработка кликов по кнопкам фильтра периода
    const periodButtons = document.querySelectorAll('.btn-group button[data-period]');

    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            const period = this.getAttribute('data-period');

            // Убираем активный класс со всех кнопок
            periodButtons.forEach(btn => btn.classList.remove('active'));

            // Добавляем активный класс к текущей кнопке
            this.classList.add('active');

            // Загружаем новые данные через AJAX
            fetch(`/api/balance-history/?days=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Обновляем данные графика
                        balanceChart.data.labels = data.data.labels;
                        balanceChart.data.datasets[0].data = data.data.data;
                        balanceChart.update();
                    } else {
                        console.error('Ошибка загрузки данных:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка запроса:', error);
                });
        });
    });
    {% endif %}
</script>
{% endblock %}
